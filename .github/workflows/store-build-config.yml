name: Store build config

on:
  repository_dispatch:
    types: [worker-deploy]
  workflow_dispatch:
    inputs:
      worker_image:
        description: Worker image ID
        required: true

jobs:
  store-build-config:
    name: Store build config
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.PAT_TOKEN_SELF }}

      - name: Set worker image
        id: worker_image
        env:
          REPOSITORY_DISPATCH_VALUE: ${{ github.event.client_payload.worker_image }}
          WORKFLOW_DISPATCH_VALUE: ${{ github.event.inputs.worker_image }}
        run: |
          WORKER_IMAGE="${REPOSITORY_DISPATCH_VALUE:-$WORKFLOW_DISPATCH_VALUE}"
          if [ "" = "$WORKER_IMAGE" ]; then
            echo "worker_image not set"
            exit 1
          fi

          echo -n "$WORKER_IMAGE" > ./worker_image
          echo "::set-output name=value::$WORKER_IMAGE"

      - name: Commit
        id: commit
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Automatic worker image update: ${{ steps.worker_image.outputs.value }}"

      - name: Trigger workflow
        if: ${{ steps.commit.outputs.changes_detected == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN_SELF }}
        run: |
          gh workflow run create-release.yml \
          -f commit_hash="${{ steps.commit.outputs.commit_hash }}" \
          -f should_release="true"
